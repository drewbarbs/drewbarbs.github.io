<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />


    <title>Drew Barbarello's Blog</title>
    <link rel="stylesheet" href="https://dbarbs.net/theme/css/main.css" />
    <link href="https://dbarbs.net/theme/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://dbarbs.net/theme/css/skylighting.css" rel="stylesheet">
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <link rel="icon" type="image/gif" href="/favicon.gif"/>

    <link href="https://dbarbs.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Drew Barbarello's Blog Atom Feed" />

        
<style>
#disassemblyListing {
    height: 10em;
}
</style>


  </head>

  <body id="index" class="home">
    <header id="banner" class="body">
      <h1><a href="https://dbarbs.net">Drew Barbarello's Blog <strong></strong></a></h1>
      <nav id="menu"><ul>
          <li><a href="https://dbarbs.net/">Home</a></li>
          <li><a href="https://dbarbs.net/archives.html">Archive</a></li>
      </ul></nav><!-- /#menu -->

    </header><!-- /#banner -->
    <div id="wrap">

    <input type="checkbox" id="width_sidebar">
    <label for="width_sidebar"><span>hide the sidebar</span></label>

    <section id="content">
  <article class="hentry">
    <header>
      <h1 class="entry-title">
        Solving Flare-On 6 #11 (<code>vv_max</code>) with angr
      </h1>
      <time class="published" datetime="2019-10-05T00:00:00-04:00">Sat, 05 October 2019</time>
      
    </header>
    <div class="entry-content">
      
<p>FireEye’s <a href="https://www.fireeye.com/blog/threat-research/2019/09/2019-flare-on-challenge-solutions.html">Flare-On Challenge</a> is an annual, purely reverse engineering-focused capture the flag event. This year’s challenge was the second I participated in, and the first one I completed. You can find my notes/scripts for all the challenges <a href="https://github.com/drewbarbs/flareon2019">here</a>. This post presents my solution to the 11th challenge, using the <a href="https://angr.io/">angr</a> symbolic execution library.</p>
<p>The hint for this challenge was “Hey, at least it’s not subleq.” A quick google search shows that SUBLEQ is an example of a “<a href="https://en.wikipedia.org/wiki/One_instruction_set_computer">One instruction set computer</a>”, and apparently there was <a href="https://www.fireeye.com/content/dam/fireeye-www/global/en/blog/threat-research/Flare-On%202017/Challenge11.pdf">a prior Flare-On challenge</a> with a <code>subleq</code>-based VM. That tips us off that this challenge is also VM-based.</p>
<p>Just looking at string references, it’s clear the function at <code>140001610</code> is where the program determines whether our input is correct. Here’s the decompilation of that function in Ghidra after I’ve marked it up:</p>
<figure>
<img src="/img/2019-10-05-check_and_print_result.png" alt="Decompilation of function at 140001610" /><figcaption>Decompilation of function at 140001610</figcaption>
</figure>
<p>We can see that <code>argv[1]</code> must be equal to “FLARE2019”. Reversing the rest of <code>vv_max.exe</code>, we figure out that the first argument to this function is a pointer to a struct representing the state of a VM. The VM is simple: just an instruction pointer and a set of 256-bit registers, without any instructions to read/write memory. <code>vv_max.exe</code> executes a program with this VM, then checks the result with the function above. Specifically, it will print the flag if <code>r2 == r20</code> when execution finishes. <code>vv_max.exe</code> takes two command line arguments, which are written into the bytecode before starting the VM.</p>
<p>Each VM instruction is implemented with its own function, and directly corresponds to an AVX/AVX2 instruction. For example, the function at <code>140003030</code> implements the instruction with opcode 3. The opcode is followed by a destination register index, and two source register indices (each represented by 1 byte).</p>
<figure>
<img src="/img/2019-10-05-vpxor.png" alt="Decompilation of function at 140003030" /><figcaption>Decompilation of function at 140003030</figcaption>
</figure>
<p>After reversing all the VM instructions, my next step was to implement a <a href="https://github.com/drewbarbs/flareon2019/blob/master/11_vv_max/disassemble.py">disassembler</a> for the VM byte code, which generates this listing:</p>
<pre id="disassemblyListing">
   0:   clearregs
   1:   movimm r0, 0000000000000000000000000000000000000000000000000000000000000000
  35:   movimm r1, 0000000000000000000000000000000000000000000000000000000000000000
  69:   movimm r3, 15111111111111111111131a1b1b1b1a15111111111111111111131a1b1b1b1a
 103:   movimm r4, 1010010204080408101010101010101010100102040804081010101010101010
 137:   movimm r5, 00101304bfbfb9b9000000000000000000101304bfbfb9b90000000000000000
 171:   movimm r6, 2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f
 205:   movimm r10, 4001400140014001400140014001400140014001400140014001400140014001
 239:   movimm r11, 0010010000100100001001000010010000100100001001000010010000100100
 273:   movimm r12, 0201000605040a09080e0d0cffffffff0201000605040a09080e0d0cffffffff
 307:   movimm r13, 000000000100000002000000040000000500000006000000ffffffffffffffff
 341:   movimm r16, ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
 375:   movimm r17, 19cde05babd9831f8c68059b7f520e513af54fa572f36e3c85ae67bb67e6096a
 409:   movimm r18, d55e1caba4823f92f111f1595bc25639a5dbb5e9cffbc0b591443771982f8a42
 443:   movimm r19, 0400000005000000060000000700000000000000010000000200000003000000
 477:   movimm r20, 0000000000000000000000000000000000000000000000000000000000000000
 511:   movimm r21, 0100000001000000010000000100000001000000010000000100000001000000
 545:   movimm r22, 0200000002000000020000000200000002000000020000000200000002000000
 579:   movimm r23, 0300000003000000030000000300000003000000030000000300000003000000
 613:   movimm r24, 0400000004000000040000000400000004000000040000000400000004000000
 647:   movimm r25, 0500000005000000050000000500000005000000050000000500000005000000
 681:   movimm r26, 0600000006000000060000000600000006000000060000000600000006000000
 715:   movimm r27, 0700000007000000070000000700000007000000070000000700000007000000
 749:   vpermd r20, r0, r20
 753:   vpermd r21, r0, r21
 757:   vpermd r22, r0, r22
 761:   vpermd r23, r0, r23
 765:   vpermd r24, r0, r24
 769:   vpermd r25, r0, r25
 773:   vpermd r26, r0, r26
 777:   vpermd r27, r0, r27
 781:   vpsrld r7, r1, 0x4
 785:   vpxor r28, r20, r21
 789:   vpxor r28, r28, r22
 793:   vpxor r28, r28, r23
 797:   vpxor r28, r28, r24
 801:   vpxor r28, r28, r25
 805:   vpxor r28, r28, r26
 809:   vpxor r28, r28, r27
 813:   vpand r7, r7, r6
 817:   vpslld r29, r17, 0x7
 821:   vpsrld r30, r17, 0x19
 825:   vpor r15, r29, r30
 829:   vpcmpeqb r8, r1, r6
 833:   vpslld r29, r17, 0x15
 837:   vpsrld r30, r17, 0xb
 841:   vpor r29, r29, r30
 845:   vpxor r15, r15, r29
 849:   vpcmpeqb r8, r1, r6
 853:   vpslld r29, r17, 0x1a
 857:   vpsrld r30, r17, 0x6
 861:   vpor r29, r29, r30
 865:   vpxor r15, r15, r29
 869:   vpxor r29, r20, r16
 873:   vpand r30, r20, r18
 877:   vpxor r29, r29, r30
 881:   vpaddd r15, r29, r15
 885:   vpaddd r20, r15, r0
 889:   vpaddb r7, r8, r7
 893:   vpxor r29, r20, r28
 897:   vpermd r17, r29, r19
 901:   vpshufb r7, r5, r7
 905:   vpslld r29, r17, 0x7
 909:   vpsrld r30, r17, 0x19
 913:   vpor r15, r29, r30
 917:   vpslld r29, r17, 0x15
 921:   vpsrld r30, r17, 0xb
 925:   vpor r29, r29, r30
 929:   vpxor r15, r15, r29
 933:   vpslld r29, r17, 0x1a
 937:   vpsrld r30, r17, 0x6
 941:   vpor r29, r29, r30
 945:   vpxor r15, r15, r29
 949:   vpaddb r2, r1, r7
 953:   vpxor r29, r21, r16
 957:   vpand r30, r21, r18
 961:   vpxor r29, r29, r30
 965:   vpaddd r15, r29, r15
 969:   vpaddd r21, r15, r0
 973:   vpxor r29, r21, r28
 977:   vpermd r17, r29, r19
 981:   vpxor r20, r20, r21
 985:   vpslld r29, r17, 0x7
 989:   vpsrld r30, r17, 0x19
 993:   vpor r15, r29, r30
 997:   vpslld r29, r17, 0x15
1001:   vpsrld r30, r17, 0xb
1005:   vpor r29, r29, r30
1009:   vpxor r15, r15, r29
1013:   vpslld r29, r17, 0x1a
1017:   vpsrld r30, r17, 0x6
1021:   vpor r29, r29, r30
1025:   vpxor r15, r15, r29
1029:   vpmaddubsw r7, r2, r10
1033:   vpxor r29, r22, r16
1037:   vpand r30, r22, r18
1041:   vpxor r29, r29, r30
1045:   vpaddd r15, r29, r15
1049:   vpaddd r22, r15, r0
1053:   vpxor r29, r22, r28
1057:   vpermd r17, r29, r19
1061:   vpxor r20, r20, r22
1065:   vpslld r29, r17, 0x7
1069:   vpsrld r30, r17, 0x19
1073:   vpor r15, r29, r30
1077:   vpslld r29, r17, 0x15
1081:   vpsrld r30, r17, 0xb
1085:   vpor r29, r29, r30
1089:   vpxor r15, r15, r29
1093:   vpslld r29, r17, 0x1a
1097:   vpsrld r30, r17, 0x6
1101:   vpor r29, r29, r30
1105:   vpxor r15, r15, r29
1109:   vpmaddwd r2, r7, r11
1113:   vpxor r29, r23, r16
1117:   vpand r30, r23, r18
1121:   vpxor r29, r29, r30
1125:   vpaddd r15, r29, r15
1129:   vpaddd r23, r15, r0
1133:   vpxor r29, r23, r28
1137:   vpermd r17, r29, r19
1141:   vpxor r20, r20, r23
1145:   vpslld r29, r17, 0x7
1149:   vpsrld r30, r17, 0x19
1153:   vpor r15, r29, r30
1157:   vpslld r29, r17, 0x15
1161:   vpsrld r30, r17, 0xb
1165:   vpor r29, r29, r30
1169:   vpxor r15, r15, r29
1173:   vpslld r29, r17, 0x1a
1177:   vpsrld r30, r17, 0x6
1181:   vpor r29, r29, r30
1185:   vpxor r15, r15, r29
1189:   vpxor r29, r24, r16
1193:   vpand r30, r24, r18
1197:   vpxor r29, r29, r30
1201:   vpaddd r15, r29, r15
1205:   vpaddd r24, r15, r0
1209:   vpxor r29, r24, r28
1213:   vpermd r17, r29, r19
1217:   vpxor r20, r20, r24
1221:   vpslld r29, r17, 0x7
1225:   vpsrld r30, r17, 0x19
1229:   vpor r15, r29, r30
1233:   vpslld r29, r17, 0x15
1237:   vpsrld r30, r17, 0xb
1241:   vpor r29, r29, r30
1245:   vpxor r15, r15, r29
1249:   vpslld r29, r17, 0x1a
1253:   vpsrld r30, r17, 0x6
1257:   vpor r29, r29, r30
1261:   vpxor r15, r15, r29
1265:   vpxor r29, r25, r16
1269:   vpand r30, r25, r18
1273:   vpxor r29, r29, r30
1277:   vpaddd r15, r29, r15
1281:   vpaddd r25, r15, r0
1285:   vpxor r29, r25, r28
1289:   vpermd r17, r29, r19
1293:   vpxor r20, r20, r25
1297:   vpshufb r2, r2, r12
1301:   vpslld r29, r17, 0x7
1305:   vpsrld r30, r17, 0x19
1309:   vpor r15, r29, r30
1313:   vpslld r29, r17, 0x15
1317:   vpsrld r30, r17, 0xb
1321:   vpor r29, r29, r30
1325:   vpxor r15, r15, r29
1329:   vpslld r29, r17, 0x1a
1333:   vpsrld r30, r17, 0x6
1337:   vpor r29, r29, r30
1341:   vpxor r15, r15, r29
1345:   vpxor r29, r26, r16
1349:   vpand r30, r26, r18
1353:   vpxor r29, r29, r30
1357:   vpaddd r15, r29, r15
1361:   vpaddd r26, r15, r0
1365:   vpxor r29, r26, r28
1369:   vpermd r17, r29, r19
1373:   vpxor r20, r20, r26
1377:   vpslld r29, r17, 0x7
1381:   vpsrld r30, r17, 0x19
1385:   vpor r15, r29, r30
1389:   vpslld r29, r17, 0x15
1393:   vpsrld r30, r17, 0xb
1397:   vpor r29, r29, r30
1401:   vpxor r15, r15, r29
1405:   vpslld r29, r17, 0x1a
1409:   vpsrld r30, r17, 0x6
1413:   vpor r29, r29, r30
1417:   vpxor r15, r15, r29
1421:   vpermd r2, r2, r13
1425:   vpxor r29, r27, r16
1429:   vpand r30, r27, r18
1433:   vpxor r29, r29, r30
1437:   vpaddd r15, r29, r15
1441:   vpaddd r27, r15, r0
1445:   vpxor r29, r27, r28
1449:   vpermd r17, r29, r19
1453:   vpxor r20, r20, r27
1457:   movimm r19, ffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000
1491:   vpand r20, r20, r19
1495:   movimm r31, 221e1b4b2d17050c15590e782326332e10074f731836580b290f5c3a0c627621
</pre>
<p>The 32 byte immediate values loaded into <code>r0</code> and <code>r1</code> in the beginning of the program are replaced by <code>argv[1]</code> (“FLAREON2019”) and <code>argv[2]</code> before the bytecode is executed. Rather than reversing the listing, I decided it would be easier to modify my disassembler to output C code, compile it, then use angr on the resulting binary to solve for the value of <code>argv[2]</code> that makes <code>r2 == r20</code> when the program exits. Why not use angr directly on <code>vv_max.exe</code>? Because the symbolic execution is massively slowed down by tracing through the VM execution.</p>
<p>The final conversion script is below. I referenced <a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/">this</a> site to find the intrinsics corresponding to each instruction. Note that at the time of the competition, prior to <a href="https://github.com/angr/angr/commit/07c7cd49b962ddabdbca36a081d57b26cd7278e1">this</a> commit, angr did not support the <code>vpmaddwd</code> instruction, so I substituted a simple C function for the intrinsic.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">#!/usr/bin/env python3</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="im">import</span> textwrap</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="im">import</span> cle</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">INSTRS <span class="op">=</span> [</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    {},  <span class="co"># clearregs, dont bother implementing</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpmaddubsw&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_maddubs_epi16&#39;</span>},</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpmaddwd&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;do_vpmaddwd&#39;</span>},</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpxor&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_xor_si256&#39;</span>},</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpor&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_or_si256&#39;</span>},</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpand&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_and_si256&#39;</span>},</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    {},  <span class="co"># bitwise_not, unused</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpaddb&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_add_epi8&#39;</span>},</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">    {},  <span class="co"># vpsubb, unused</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">    {},  <span class="co"># vpaddw, unused</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    {},  <span class="co"># vpsubw, unused</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpaddd&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_add_epi32&#39;</span>},</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">    {},  <span class="co"># vpsubd, unused</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">    {},  <span class="co"># vpaddq, unused</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    {},  <span class="co"># vpsubq, unused</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    {},  <span class="co"># vpmulq, unused</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">    {},  <span class="co"># movreg, unused</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;movimm&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;imm256&#39;</span>]},</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpsrld&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;imm8&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_srli_epi32&#39;</span>},</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpslld&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;imm8&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_slli_epi32&#39;</span>},</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpshufb&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_shuffle_epi8&#39;</span>},</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpermd&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_permutevar8x32_epi32&#39;</span>},</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">    {<span class="st">&#39;mnemonic&#39;</span>: <span class="st">&#39;vpcmpeqb&#39;</span>, <span class="st">&#39;args&#39;</span>: [<span class="st">&#39;r&#39;</span>, <span class="st">&#39;r&#39;</span>], <span class="st">&#39;intrinsic&#39;</span>: <span class="st">&#39;_mm256_cmpeq_epi8&#39;</span>},</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">    {}   <span class="co"># nop, unused</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31">]</a>
<a class="sourceLine" id="cb1-32" data-line-number="32"></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">TEMPLATE <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="st">#include &lt;immintrin.h&gt;</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="sc">{constants}</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="sc">{vpmaddwd_implementation}</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"><span class="st">int main(int argc, char **argv) </span><span class="sc">{{</span></a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="st">    // Code to initialize variables r0-r31 to zero</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42"><span class="sc">{zero_init_regs}</span></a>
<a class="sourceLine" id="cb1-43" data-line-number="43"><span class="st">    // Converted bytecode</span></a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="sc">{body}</span></a>
<a class="sourceLine" id="cb1-45" data-line-number="45"></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="st">    // Replicate the checks from the function at 140001610 of vv_max.exe</span></a>
<a class="sourceLine" id="cb1-47" data-line-number="47"><span class="st">    __m256i cmpresult = _mm256_cmpeq_epi8(r2, r20);</span></a>
<a class="sourceLine" id="cb1-48" data-line-number="48"><span class="st">    int32_t result = _mm256_movemask_epi8(cmpresult);</span></a>
<a class="sourceLine" id="cb1-49" data-line-number="49"></a>
<a class="sourceLine" id="cb1-50" data-line-number="50"><span class="st">    // We want result == -1</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51"><span class="st">    return result;</span></a>
<a class="sourceLine" id="cb1-52" data-line-number="52"><span class="sc">}}</span></a>
<a class="sourceLine" id="cb1-53" data-line-number="53"><span class="st">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54"></a>
<a class="sourceLine" id="cb1-55" data-line-number="55">VPMADDWD_IMPLEMENTATION <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-56" data-line-number="56"><span class="st">__m256i do_vpmaddwd(__m256i a, __m256i b) {</span></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"><span class="st">    int32_t intermediate[16] = </span><span class="sc">{0}</span><span class="st">;</span></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="st">    int32_t result[8] = </span><span class="sc">{0}</span><span class="st">;</span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59"><span class="st">    for (int i = 0; i &lt; 16; ++i) {</span></a>
<a class="sourceLine" id="cb1-60" data-line-number="60"><span class="st">        intermediate[i] = ((int16_t*)&amp;a)[i] * ((int16_t*)&amp;b)[i];</span></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="st">    }</span></a>
<a class="sourceLine" id="cb1-62" data-line-number="62"></a>
<a class="sourceLine" id="cb1-63" data-line-number="63"><span class="st">    for (int i = 0; i &lt; 8; ++i) {</span></a>
<a class="sourceLine" id="cb1-64" data-line-number="64"><span class="st">        result[i] = intermediate[2*i] + intermediate[2*i + 1];</span></a>
<a class="sourceLine" id="cb1-65" data-line-number="65"><span class="st">    }</span></a>
<a class="sourceLine" id="cb1-66" data-line-number="66"></a>
<a class="sourceLine" id="cb1-67" data-line-number="67"><span class="st">    return _mm256_loadu_si256((__m256i const *)result);</span></a>
<a class="sourceLine" id="cb1-68" data-line-number="68"><span class="st">}</span></a>
<a class="sourceLine" id="cb1-69" data-line-number="69"><span class="st">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb1-70" data-line-number="70"></a>
<a class="sourceLine" id="cb1-71" data-line-number="71">vv_max <span class="op">=</span> cle.Loader(<span class="st">&#39;vv_max.exe&#39;</span>)</a>
<a class="sourceLine" id="cb1-72" data-line-number="72">vv_max.memory.seek(<span class="bn">0x140015350</span>)</a>
<a class="sourceLine" id="cb1-73" data-line-number="73">code <span class="op">=</span> vv_max.memory.read(<span class="bn">0x5fb</span>)</a>
<a class="sourceLine" id="cb1-74" data-line-number="74"></a>
<a class="sourceLine" id="cb1-75" data-line-number="75">code <span class="op">=</span> code[<span class="dv">1</span>:]  <span class="co"># skip the first instruction &quot;clearregs&quot;</span></a>
<a class="sourceLine" id="cb1-76" data-line-number="76">constants <span class="op">=</span> []</a>
<a class="sourceLine" id="cb1-77" data-line-number="77">statements <span class="op">=</span> []</a>
<a class="sourceLine" id="cb1-78" data-line-number="78"></a>
<a class="sourceLine" id="cb1-79" data-line-number="79"><span class="cf">while</span> code <span class="kw">and</span> code[<span class="dv">0</span>] <span class="op">!=</span> <span class="bn">0xff</span>:</a>
<a class="sourceLine" id="cb1-80" data-line-number="80">    opcode, dstreg, code <span class="op">=</span> code[<span class="dv">0</span>], code[<span class="dv">1</span>], code[<span class="dv">2</span>:]</a>
<a class="sourceLine" id="cb1-81" data-line-number="81"></a>
<a class="sourceLine" id="cb1-82" data-line-number="82">    <span class="cf">if</span> INSTRS[opcode][<span class="st">&#39;mnemonic&#39;</span>] <span class="op">==</span> <span class="st">&#39;movimm&#39;</span>:</a>
<a class="sourceLine" id="cb1-83" data-line-number="83">        immediate, code <span class="op">=</span> code[:<span class="dv">32</span>], code[<span class="dv">32</span>:]</a>
<a class="sourceLine" id="cb1-84" data-line-number="84">        immarr <span class="op">=</span> <span class="st">&#39;{&#39;</span> <span class="op">+</span> <span class="st">&#39;, &#39;</span>.join(<span class="bu">hex</span>(b) <span class="cf">for</span> b <span class="kw">in</span> immediate) <span class="op">+</span> <span class="st">&#39;}&#39;</span></a>
<a class="sourceLine" id="cb1-85" data-line-number="85">        constsym <span class="op">=</span> <span class="ss">f&#39;CONST</span><span class="sc">{</span><span class="bu">len</span>(constants)<span class="sc">}</span><span class="ss">&#39;</span></a>
<a class="sourceLine" id="cb1-86" data-line-number="86">        constdecl <span class="op">=</span> <span class="ss">f&#39;const char </span><span class="sc">{</span>constsym<span class="sc">}</span><span class="ss">[32] = </span><span class="sc">{</span>immarr<span class="sc">}</span><span class="ss">;&#39;</span></a>
<a class="sourceLine" id="cb1-87" data-line-number="87">        constants.append(constdecl)</a>
<a class="sourceLine" id="cb1-88" data-line-number="88">        statements.append(<span class="ss">f&#39;r</span><span class="sc">{</span>dstreg<span class="sc">}</span><span class="ss"> = _mm256_loadu_si256((__m256i const *)</span><span class="sc">{</span>constsym<span class="sc">}</span><span class="ss">);&#39;</span>)</a>
<a class="sourceLine" id="cb1-89" data-line-number="89">        <span class="cf">continue</span></a>
<a class="sourceLine" id="cb1-90" data-line-number="90"></a>
<a class="sourceLine" id="cb1-91" data-line-number="91">    instrinfo <span class="op">=</span> INSTRS[opcode]</a>
<a class="sourceLine" id="cb1-92" data-line-number="92">    args <span class="op">=</span> []</a>
<a class="sourceLine" id="cb1-93" data-line-number="93">    <span class="cf">for</span> argtype <span class="kw">in</span> instrinfo[<span class="st">&#39;args&#39;</span>]:</a>
<a class="sourceLine" id="cb1-94" data-line-number="94">        <span class="cf">if</span> argtype <span class="op">==</span> <span class="st">&#39;r&#39;</span>:</a>
<a class="sourceLine" id="cb1-95" data-line-number="95">            rnum, code <span class="op">=</span> code[<span class="dv">0</span>], code[<span class="dv">1</span>:]</a>
<a class="sourceLine" id="cb1-96" data-line-number="96">            args.append(<span class="ss">f&#39;r</span><span class="sc">{</span>rnum<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb1-97" data-line-number="97">        <span class="cf">elif</span> argtype <span class="op">==</span> <span class="st">&#39;imm8&#39;</span>:</a>
<a class="sourceLine" id="cb1-98" data-line-number="98">            imm, code <span class="op">=</span> code[<span class="dv">0</span>], code[<span class="dv">1</span>:]</a>
<a class="sourceLine" id="cb1-99" data-line-number="99">            args.append(<span class="ss">f&#39;</span><span class="sc">{</span><span class="bu">hex</span>(imm)<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb1-100" data-line-number="100">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb1-101" data-line-number="101">            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f&#39;Unrecognized argument type </span><span class="sc">{</span>argtype<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb1-102" data-line-number="102">    intrinsic <span class="op">=</span> instrinfo[<span class="st">&#39;intrinsic&#39;</span>]</a>
<a class="sourceLine" id="cb1-103" data-line-number="103">    arglist <span class="op">=</span> <span class="st">&#39;, &#39;</span>.join(args)</a>
<a class="sourceLine" id="cb1-104" data-line-number="104">    statements.append(<span class="ss">f&#39;r</span><span class="sc">{</span>dstreg<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>intrinsic<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>arglist<span class="sc">}</span><span class="ss">);&#39;</span>)</a>
<a class="sourceLine" id="cb1-105" data-line-number="105"></a>
<a class="sourceLine" id="cb1-106" data-line-number="106">src <span class="op">=</span> TEMPLATE.<span class="bu">format</span>(</a>
<a class="sourceLine" id="cb1-107" data-line-number="107">    constants<span class="op">=</span><span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(constants),</a>
<a class="sourceLine" id="cb1-108" data-line-number="108">    vpmaddwd_implementation<span class="op">=</span>VPMADDWD_IMPLEMENTATION,</a>
<a class="sourceLine" id="cb1-109" data-line-number="109">    zero_init_regs<span class="op">=</span>textwrap.indent(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(<span class="ss">f&#39;__m256i r</span><span class="sc">{i}</span><span class="ss"> = _mm256_setzero_si256();&#39;</span></a>
<a class="sourceLine" id="cb1-110" data-line-number="110">                                             <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">32</span>)),</a>
<a class="sourceLine" id="cb1-111" data-line-number="111">                                   <span class="st">&#39; &#39;</span><span class="op">*</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1-112" data-line-number="112">    body<span class="op">=</span>textwrap.indent(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>.join(statements), <span class="st">&#39; &#39;</span><span class="op">*</span><span class="dv">4</span>))</a>
<a class="sourceLine" id="cb1-113" data-line-number="113"></a>
<a class="sourceLine" id="cb1-114" data-line-number="114"><span class="bu">print</span>(src)</a></code></pre></div>
<p>This script outputs a C source file. Compile that with <code>gcc -o converted -mavx2 out.c</code> and we can run the following script to leverage angr to solve for the value of <code>argv[2]</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">#!/usr/bin/env python3</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="im">import</span> angr</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="im">import</span> claripy</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">proj <span class="op">=</span> angr.Project(<span class="st">&#39;./converted&#39;</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">main_addr <span class="op">=</span> proj.loader.find_symbol(<span class="st">&#39;main&#39;</span>).rebased_addr</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co"># Address of initializer for r0 (corresponds to vv_max.exe argv[1])</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">const0_addr <span class="op">=</span> proj.loader.find_symbol(<span class="st">&#39;CONST0&#39;</span>).rebased_addr</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co"># Address of initializer for r1 (corresponds to vv_max.exe argv[2])</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">const1_addr <span class="op">=</span> proj.loader.find_symbol(<span class="st">&#39;CONST1&#39;</span>).rebased_addr</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co"># Write &quot;FLARE2019&quot; into CONST0</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">proj.loader.memory.store(const0_addr, b<span class="st">&#39;FLARE2019&#39;</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co"># Find address of ret instruction in main()</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">cfg <span class="op">=</span> proj.analyses.CFGFast(force_complete_scan<span class="op">=</span><span class="va">False</span>,</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">                            function_starts<span class="op">=</span>[main_addr])</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">ret_block, <span class="op">=</span> cfg.functions[main_addr].ret_sites</a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="cf">assert</span> ret_block.bytestr[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="bn">0xc3</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">ret_addr <span class="op">=</span> ret_block.addr <span class="op">+</span> ret_block.size <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">initial_state <span class="op">=</span> proj.factory.entry_state()</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">simmgr <span class="op">=</span> proj.factory.simulation_manager(initial_state)</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">simmgr.explore(find<span class="op">=</span>main_addr).unstash(from_stash<span class="op">=</span><span class="st">&#39;found&#39;</span>, to_stash<span class="op">=</span><span class="st">&#39;active&#39;</span>)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26"></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">active, <span class="op">=</span> simmgr.active</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">arg2 <span class="op">=</span> claripy.BVS(<span class="st">&#39;arg2&#39;</span>, <span class="bn">0x20</span> <span class="op">*</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">active.memory.store(const1_addr, arg2)</a>
<a class="sourceLine" id="cb2-30" data-line-number="30"></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">simmgr.explore(find<span class="op">=</span>ret_addr)</a>
<a class="sourceLine" id="cb2-32" data-line-number="32"></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">found, <span class="op">=</span> simmgr.found</a>
<a class="sourceLine" id="cb2-34" data-line-number="34">found.solver.add(found.regs.eax <span class="op">==</span> <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"></a>
<a class="sourceLine" id="cb2-36" data-line-number="36"><span class="co"># Restrict solutions to be alphanumeric</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37"><span class="cf">for</span> b <span class="kw">in</span> arg2.chop(<span class="dv">8</span>):</a>
<a class="sourceLine" id="cb2-38" data-line-number="38">    found.solver.add(found.solver.Or(</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">        found.solver.And(b <span class="op">&gt;=</span> <span class="bu">ord</span>(<span class="st">&#39;A&#39;</span>), b <span class="op">&lt;=</span> <span class="bu">ord</span>(<span class="st">&#39;Z&#39;</span>)),</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">        found.solver.And(b <span class="op">&gt;=</span> <span class="bu">ord</span>(<span class="st">&#39;a&#39;</span>), b <span class="op">&lt;=</span> <span class="bu">ord</span>(<span class="st">&#39;z&#39;</span>)),</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">        found.solver.And(b <span class="op">&gt;=</span> <span class="bu">ord</span>(<span class="st">&#39;0&#39;</span>), b <span class="op">&lt;=</span> <span class="bu">ord</span>(<span class="st">&#39;9&#39;</span>))))</a>
<a class="sourceLine" id="cb2-42" data-line-number="42"></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">arg2_value <span class="op">=</span> found.solver.eval_one(arg2, cast_to<span class="op">=</span><span class="bu">bytes</span>).decode(<span class="st">&#39;utf8&#39;</span>)</a>
<a class="sourceLine" id="cb2-44" data-line-number="44"><span class="bu">print</span>(<span class="ss">f&#39;arg2 needs to be &quot;</span><span class="sc">{</span>arg2_value<span class="sc">}</span><span class="ss">&quot;&#39;</span>)</a></code></pre></div>
<p>Finally, we have what we need to solve the challenge!</p>
<p><img src="/img/2019-10-05-solve.png" title="Solving Flare-On 6 #11" /></p>

    </div><!-- /.entry-content -->

    <section class="comments">
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "posts/2019/10/solving-flare-on-6-11-vv_max-with-angr/";
        var disqus_url = "https://dbarbs.net/posts/2019/10/solving-flare-on-6-11-vv_max-with-angr/";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://dbarbs.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </section> <!-- /.comments -->
  </article>
    </section><!-- /#content -->
<aside id="sidebar">
    <section>
    <h1>Social</h1>
      <ul id="social">
        <li><a href="https://www.facebook.com/andrew.barbarello"><i
                                                            class="fa fa-facebook-square fa-lg"></i>facebook</a></li>
        <li><a href="https://twitter.com/_dbarbs"><i
                                                            class="fa fa-twitter-square fa-lg"></i>twitter</a></li>
      </ul>
    </section>

    <section><h1>Recent Posts</h1>
      <ul id="recentposts">
        <li>
          <a href="https://dbarbs.net/posts/2019/10/solving-flare-on-6-11-vv_max-with-angr/">Solving Flare-On 6 #11 (<code>vv_max</code>) with angr</a>
        </li>
        <li>
          <a href="https://dbarbs.net/posts/2018/05/deriving-perspective-and-parallel-projection-matrices/">Deriving Perspective and Parallel Projection Matrices</a>
        </li>
        <li>
          <a href="https://dbarbs.net/posts/2017/01/grokking-bezier-curves/">Grokking Bézier Curves</a>
        </li>
        <li>
          <a href="https://dbarbs.net/posts/2014/07/unqualified-failure/">Unqualified failure</a>
        </li>
        <li>
          <a href="https://dbarbs.net/posts/2014/02/installing-clover-os-x-and-linux-mint/">Installing Clover, OS X, and Linux Mint</a>
        </li>
      </ul>
    </section>



    <section>
      <h1>GitHub Repos</h1>
        <div id="gh_repos">
            <p class="loading-status">Status updating...</p>
        </div>
    </section>
</aside>    </div>
    <footer id="contentinfo" class="body">
      <address id="about" class="vcard body">
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="http://python.org">Python</a>.
      </address><!-- /#about -->
    </footer><!-- /#contentinfo -->
    <script src="https://dbarbs.net/theme/js/github.js" type="text/javascript"></script>
    <script>
            github.showRepos({
                user: 'drewbarbs',
                count: 5,
                skip_forks: true,
                target: 'gh_repos' //id of the target div
            });
    </script>
    
  </body>
</html>